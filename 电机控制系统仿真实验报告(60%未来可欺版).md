# 电机控制系统仿真实验报告

<center><div style='height:2mm;'></div><div style="font-family:华文楷体;font-size:14pt;">金嘉楠</div></center>
<center><span style="font-family:华文楷体;font-size:9pt">哈尔滨工程大学创梦之翼战队，电控组，17845272822@163.com<br /></span>

注：格式注意首行缩进两个字符

## STM32单片机配置

### CubeMX内核配置

注：应采用无序列表，要求上传 System Core 中 RCC 和 SYS 配置结果截图。

- RCC
    -[image1-rcc1](https://gitee.com/caelem/light-test/blob/master/image1/rcc1.jpg)
- SYS
    -[image1-sys1](https://gitee.com/caelem/light-test/blob/master/image1/sys1.jpg)
- …

### CubeMX外设配置

注：应采用无序列表，要求上传 CubeMX 的 Connectivity 中 Usart 的配置结果截图。若使用中断或DMA，则上传相应的中断或DMA相应配置内容的截图。

- 串口
    -[image1-usart1](https://gitee.com/caelem/light-test/blob/master/image1/usart1.jpg)
- 中断设置
- DMA设置
    -[image1-DMA1](https://gitee.com/caelem/light-test/blob/master/image1/DMA1.jpg)

### CubeMX时钟配置

　　要求上传时钟树 Clock Configuration 的配置结果截图。
   [image1-clock1](https://gitee.com/caelem/light-test/blob/master/image1/clock1.jpg)

## 嵌入式系统设计

注：可参考官方论坛各参赛队开源技术报告。

### 嵌入式软件框架

　　嵌入式软件框架图，可通过drawio绘制。

### 上位机通信程序设计

#### 串口发送

　　简述实现方法与代码分析，注意代码应使用代码块。

```C
 printf("line1=%f\n", voltage);

```

#### 串口接收

　　简述实现方法与代码分析，注意代码应使用代码块。

```C
void UART_IDLE_Callback(UART_HandleTypeDef *huart)
{
  if (__HAL_UART_GET_FLAG(huart, UART_FLAG_IDLE))
  {
    __HAL_UART_CLEAR_IDLEFLAG(huart);
    (void)USART1->SR;
    (void)USART1->DR;
    __HAL_DMA_CLEAR_FLAG(huart, DMA_FLAG_TC5);
    HAL_UART_DMAStop(huart);

    int len = 100 - __HAL_DMA_GET_COUNTER(huart->hdmarx);
    HAL_UART_Transmit(&huart1, receive_data, len, 10);
    HAL_UART_Receive_DMA(huart, receive_data, 100); // 再次使能接受，NDTR重载
  }
}
```



## 控制系统设计与实现

### 速度闭环

#### 系统框图

　　利用drawio绘制速度闭环控制系统方框图，可参考：[（3）系统方框图 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/399384279)，要求明确各 Block 的输入输出。

#### 系统关键代码

　　注意代码应使用代码块

```C
void PID_Init(PID_t *PID, float kp, float ki, float kd)
{
	PID->kp = kp;
	PID->ki = ki;
	PID->kd = kd;
}

float PID_Calculate(PID_t *PID, float ref, float measure, float dt)
{
	PID->error = ref - measure;
	if (PID->LastError != 0)
	{
		PID->AveError = (PID->error + PID->LastError) / 2;
		PID->integral += PID->AveError;
	}
	else
	{
		PID->integral += PID->error;
	}
	PID->u = PID->kp * PID->error + PID->ki * PID->integral * dt + PID->kd * (PID->error - PID->LastError) / dt;
  if(PID->integral>20000)
  {
    PID->integral = 0;
  }
	PID->LastError = PID->error;

	return PID->u;
}


```

### 角度闭环

#### 系统框图

##### 单级反馈控制

　　利用drawio绘制角度闭环单级反馈控制系统方框图

##### 串级反馈控制

　　利用drawio绘制角度闭环串级反馈控制系统方框图

#### 系统关键代码

##### 单级反馈控制

　　注意代码应使用代码块

```C

``` Motor_Object_Init(&Motor);
  PID_Init(&K, 120.0, 1.00000001e-07, 1e-15);
  DWT_Init(72);
  __HAL_UART_ENABLE_IT(&huart1, UART_IT_IDLE);
  HAL_UART_Receive_DMA(&huart1, receive_data, 100); 

  ang = Get_Motor_Angle(&Motor);
    float voltage = PID_Calculate(&K, refang, ang, dt);
    Motor_Simulation(&Motor, voltage, dt);//1

    while (1)
  {
		t=t+10;
    dt = DWT_GetDeltaT(&DWT_CNT);
    t = t * pi / 180;
    refvel = 10 * sin(0.707 * t);
    vel = Get_Motor_Velocity(&Motor);
    ang = Get_Motor_Angle(&Motor);
    float voltage = PID_Calculate(&K, refvel, vel, dt);
    Motor_Simulation(&Motor, voltage, dt);
    printf("line1=%.4f,line2=%.4f\r\n", vel, refvel);
    HAL_Delay(1);
  }//2
   

##### 串级反馈控制

　　注意代码应使用代码块

```C

```

### 复合控制

#### 复合控制系统框图与设计思路

　　利用drawio绘制角度闭环串级反馈控制系统方框图，并写明设计思路。

#### 复合控制系统关键代码

　　注意代码应使用代码块

```C

```

## 实验结论与分析

注：所有图片均需标明横纵坐标单位。

### 速度闭环系统阶跃响应

![image-20220124093224373](http://hongxiwong-pic.oss-cn-beijing.aliyuncs.com/img/image-20220124093224373.png)

### 速度闭环系统频率响应

![image-20220124093513534](http://hongxiwong-pic.oss-cn-beijing.aliyuncs.com/img/image-20220124093513534.png)

$\omega_0 = 41 \ rad/s$

### 角度闭环系统阶跃响应

应至少包含期望角度与两种闭环控制系统实际角度，共三条曲线。并对比分析结果。

[image1-refang=2pi](https://gitee.com/caelem/light-test/blob/master/image1/refang=2pi.jpg)

### 角度闭环系统阶频率

图1应至少包含期望角度与单级控制系统实际角度，共两条曲线。

图2应至少包含期望角度与串级控制系统实际角度，共两条曲线。

并对比分析结果。

[image-refang=2pisin(w0t)](https://gitee.com/caelem/light-test/blob/master/image1/refang=2pisin(w0t).jpg)

$\omega_0 = 2.8\ rad/s$

### 角度闭环系统抗扰性能

　　两张图：

图1应至少包含扰动输入与两种闭环控制系统控制器输出，共三条曲线。并对比分析结果。

图2应至少包含两种闭环控制系统实际角度，共两条曲线。

### 复合控制系统阶跃响应

　　一张图：

应至少包含期望角度与复合控制系统实际角度，共两条曲线。并对比分析结果。

### 复合控制系统频率响应

![image-20220124110151555](http://hongxiwong-pic.oss-cn-beijing.aliyuncs.com/img/image-20220124110151555.png)

$\omega_0 = 6.5\ rad/s$

### 复合控制系统抗扰性能

　　两张图：

图1应至少包含扰动输入与三种控制系统控制器输出四条曲线。并对比分析结果。

图2应至少包含三种闭环控制系统实际角度三条曲线。
